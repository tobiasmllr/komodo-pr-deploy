name: Build komodo-cli Image

on:
    push:
        branches: [main]
        paths:
            - 'docker/komodo-cli.Dockerfile'
            - 'deploy.mjs'
            - 'package.json'
            - 'package-lock.json'
            - '.github/workflows/build-komodo-cli.yml'
    pull_request:
        branches: [main]
    workflow_dispatch:
        inputs:
            trigger_build:
                description: 'Actually trigger the Komodo build'
                required: true
                default: true
                type: boolean

jobs:
    build:
        # Only run on the komodo-pr-deploy repo itself
        if: github.repository == 'tobiasmllr/komodo-pr-deploy'
        runs-on: ubuntu-latest
        environment: komodo

        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Trigger Komodo build for komodo-cli
              # Auto-trigger for: push to main, manual dispatch with trigger_build, or Renovate PRs
              if: |
                  github.event_name == 'push' ||
                  (github.event_name == 'workflow_dispatch' && inputs.trigger_build) ||
                  (github.event_name == 'pull_request' && startsWith(github.head_ref, 'renovate/'))
              env:
                  KOMODO_URL: ${{ secrets.KOMODO_URL }}
                  KOMODO_API_KEY: ${{ secrets.KOMODO_API_KEY }}
                  KOMODO_API_SECRET: ${{ secrets.KOMODO_API_SECRET }}
              run: |
                  echo "ðŸ”¨ Triggering Komodo to build komodo-cli image..."

                  # Use the build name as configured in Komodo
                  # (Check your Komodo UI for the exact build name)
                  BUILD_NAME="komodo-cli"

                  # Trigger the build
                  echo "ðŸš€ Starting build: ${BUILD_NAME}..."
                  BUILD_RESPONSE=$(curl -s -X POST \
                      -H "Content-Type: application/json" \
                      -H "X-API-KEY: ${KOMODO_API_KEY}" \
                      -H "X-API-SECRET: ${KOMODO_API_SECRET}" \
                      "${KOMODO_URL}/execute/RunBuild" \
                      -d "{\"build\": \"${BUILD_NAME}\"}")

                  echo "Build trigger response: $BUILD_RESPONSE"

                  # Check for errors in response
                  if echo "$BUILD_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
                      echo "âŒ Build trigger failed: $BUILD_RESPONSE"
                      exit 1
                  fi

                  echo "âœ… Build triggered, waiting for completion..."

                  # Poll for build completion
                  MAX_ATTEMPTS=20
                  ATTEMPT=0

                  while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
                      ATTEMPT=$((ATTEMPT + 1))
                      echo "ðŸ“‹ Checking build status (attempt ${ATTEMPT}/${MAX_ATTEMPTS})..."

                      sleep 30

                      STATUS_RESPONSE=$(curl -s -X POST \
                          -H "Content-Type: application/json" \
                          -H "X-API-KEY: ${KOMODO_API_KEY}" \
                          -H "X-API-SECRET: ${KOMODO_API_SECRET}" \
                          "${KOMODO_URL}/read/ListBuilds" \
                          -d '{}')

                      # Extract state for the build
                      BUILD_STATE=$(echo "$STATUS_RESPONSE" | jq -r ".[] | select(.name == \"${BUILD_NAME}\") | .info.state // \"unknown\"")

                      echo "ðŸ“Š Build state: $BUILD_STATE"

                      if [ "$BUILD_STATE" = "Ok" ] || [ "$BUILD_STATE" = "complete" ] || [ "$BUILD_STATE" = "success" ]; then
                          echo "âœ… Build completed successfully!"
                          exit 0
                      elif [ "$BUILD_STATE" = "failed" ] || [ "$BUILD_STATE" = "error" ] || [ "$BUILD_STATE" = "Failed" ]; then
                          echo "âŒ Build failed with state: $BUILD_STATE"
                          exit 1
                      fi

                      echo "â³ Build still running..."
                  done

                  echo "âŒ Build did not complete within $((MAX_ATTEMPTS * 30 / 60)) minutes"
                  exit 1

            - name: PR validation note
              if: |
                  (github.event_name == 'pull_request' && !startsWith(github.head_ref, 'renovate/')) ||
                  (github.event_name == 'workflow_dispatch' && !inputs.trigger_build)
              run: |
                  echo "â„¹ï¸ Non-Renovate PR detected - skipping build trigger"
                  echo "The Dockerfile and related files will be validated when merged to main"

            - name: Build summary
              if: always()
              env:
                  DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
              run: |
                  echo "## ðŸ³ komodo-cli Build" >> $GITHUB_STEP_SUMMARY
                  echo "- **Image**: ${DOCKER_REGISTRY}/mop/komodo-cli:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
                  if [[ "${{ github.head_ref }}" == renovate/* ]]; then
                      echo "- **Source**: Renovate PR" >> $GITHUB_STEP_SUMMARY
                  fi
