name: Build komodo-cli Image

on:
    push:
        branches: [main]
        paths:
            - 'docker/komodo-cli.Dockerfile'
            - 'deploy.mjs'
            - 'package.json'
    pull_request:
        branches: [main]
        paths:
            - 'docker/komodo-cli.Dockerfile'
            - 'deploy.mjs'
            - 'package.json'
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        environment: komodo

        steps:
            - name: Trigger Komodo build for komodo-cli
              if: github.event_name != 'pull_request'
              env:
                  KOMODO_URL: ${{ secrets.KOMODO_URL }}
                  KOMODO_API_KEY: ${{ secrets.KOMODO_API_KEY }}
                  KOMODO_API_SECRET: ${{ secrets.KOMODO_API_SECRET }}
              run: |
                  echo "ðŸ”¨ Triggering Komodo to build komodo-cli image..."

                  # Trigger the build
                  echo "ðŸš€ Starting build..."
                  BUILD_RESPONSE=$(curl -s -X POST \
                      -H "Content-Type: application/json" \
                      -H "X-API-KEY: ${KOMODO_API_KEY}" \
                      -H "X-API-SECRET: ${KOMODO_API_SECRET}" \
                      "${KOMODO_URL}/execute/RunBuild" \
                      -d '{"build": "komodo-cli-build"}')

                  echo "Build trigger response: $BUILD_RESPONSE"

                  if echo "$BUILD_RESPONSE" | grep -q '"error"'; then
                      echo "âŒ Build trigger failed: $BUILD_RESPONSE"
                      exit 1
                  fi

                  echo "âœ… Build triggered, waiting for completion..."

                  # Poll for build completion
                  MAX_ATTEMPTS=20
                  ATTEMPT=0

                  while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
                      ATTEMPT=$((ATTEMPT + 1))
                      echo "ðŸ“‹ Checking build status (attempt ${ATTEMPT}/${MAX_ATTEMPTS})..."

                      STATUS_RESPONSE=$(curl -s -X POST \
                          -H "Content-Type: application/json" \
                          -H "X-API-KEY: ${KOMODO_API_KEY}" \
                          -H "X-API-SECRET: ${KOMODO_API_SECRET}" \
                          "${KOMODO_URL}/read/ListBuilds" \
                          -d '{}')

                      # Extract state for komodo-cli-build
                      BUILD_STATE=$(echo "$STATUS_RESPONSE" | jq -r '.[] | select(.name == "komodo-cli-build") | .info.state // "unknown"')

                      echo "ðŸ“Š Build state: $BUILD_STATE"

                      if [ "$BUILD_STATE" = "Ok" ] || [ "$BUILD_STATE" = "complete" ] || [ "$BUILD_STATE" = "success" ]; then
                          echo "âœ… Build completed successfully!"
                          exit 0
                      elif [ "$BUILD_STATE" = "failed" ] || [ "$BUILD_STATE" = "error" ]; then
                          echo "âŒ Build failed with state: $BUILD_STATE"
                          exit 1
                      fi

                      echo "â³ Build still running... waiting 30 seconds"
                      sleep 30
                  done

                  echo "âŒ Build did not complete within $((MAX_ATTEMPTS * 30 / 60)) minutes"
                  exit 1

            - name: PR validation note
              if: github.event_name == 'pull_request'
              run: |
                  echo "â„¹ï¸ PR detected - skipping build trigger"
                  echo "The Dockerfile and related files will be validated when merged to main"

            - name: Build summary
              run: |
                  echo "## ðŸ³ komodo-cli Build" >> $GITHUB_STEP_SUMMARY
                  echo "- **Image**: ${{ secrets.DOCKER_REGISTRY }}/komodo-cli:latest" >> $GITHUB_STEP_SUMMARY
                  if [ "${{ github.event_name }}" != "pull_request" ]; then
                      echo "- **Status**: âœ… Build triggered on Komodo" >> $GITHUB_STEP_SUMMARY
                  else
                      echo "- **Status**: â„¹ï¸ PR - build skipped (will trigger on merge)" >> $GITHUB_STEP_SUMMARY
                  fi
